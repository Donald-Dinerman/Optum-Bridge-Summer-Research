---
title: "Predictive Modeling"
output: html_document
date: '2022-06-29'
---

# Goal

Develop a model to predict length of life using Health Behaviors

Determine variable to define length of life.

Determine the mix of predictors (i.e., specific x's and categories).

# Data Documentation

```{r}
#(https://www.countyhealthrankings.org/explore-health-rankings/measures-data-sources/county-health-rankings-model?componentType=factor-area&componentId=3)
```

* Additional Measure (not included in ranks)

## Length of Life

Premature Death: Years of potential life (YPLL) lost before age 75 per 100,000 population (age-adjusted)

Life Expectancy: Average number of years a person can expect to live.

## Health Behaviors

*Tobacco*
Adult Smoking: Percentage of adults who are current smokers (age-adjusted).

*Sexual Activity*
Sexually Transmitted Infections: Number of newly diagnosed chlamydia cases per 100,000 population.

*Alcohol and Drug Use*
Excessive Drinking: Percentage of adults reporting binge or heavy drinking (age-adjusted).

Alcohol-Impaired Driving Deaths: Percentage of driving deaths with alcohol involvement.

Drug Overdose Deaths*: Number of drug poisoning deaths per 100,000 population.

Motor Vehicle Crash Deaths*: Number of motor vehicle crash deaths per 100,000 population.

*Diet and Exercise*
Adult Obesity: Percentage of the adult population (age 18 and older) that reports a body mass index (BMI) greater than or equal to 30 kg/m2 (age-adjusted).

Food Environment Index: Index of factors that contribute to a healthy food environment, from 0 (worst) to 10 (best). 

Physical Inactivity: Percentage of adults age 18 and over reporting no leisure-time physical activity (age-adjusted). 

Access to Exercise Opportunities: Percentage of population with adequate access to locations for physical activity.

Food Insecurity*: Percentage of population who lack adequate access to food.

Limited Access to Healthy Foods*: Percentage of population who are low-income and do not live close to a grocery store.

## Social and Economic Factors

*Employment*
Unemployment: Percentage of population ages 16 and older unemployed but seeking work.

*Education*
High School Completion: Percentage of adults ages 25 and over with a high school diploma or equivalent.

Some College: Percentage of adults ages 25-44 with some post-secondary education.

High School Graduation*: Percentage of ninth-grade cohort that graduates in four years.

*Income*
Income Inequality: Ratio of household income at the 80th percentile to income at the 20th percentile.

Median Household Income*: The income where half of households in a county earn more and half of households earn less.

Living Wage*: The hourly wage needed to cover basic household expenses plus all relevant taxes for a household of one adult and two children.

*Community Safety*
Violent Crime: Number of reported violent crime offenses per 100,000 population.

Injury Deaths: Number of deaths due to injury per 100,000 population.

Homicides*: Number of deaths due to homicide per 100,000 population.

Suicides*: Number of deaths due to suicide per 100,000 population (age-adjusted).

Firearm Fatalities*: Number of deaths due to firearms per 100,000 population.

Juvenile Arrests*: Rate of delinquency cases per 1,000 juveniles.

# Notes

```{r}
# Equity in ML
#(http://www.datasciencepublicpolicy.org/our-work/tools-guides/aequitas/)
```

# Read Data

```{r}
library(tidyverse)
library(readxl)
```

```{r, message=F, warning=F}
#r project establishes root wd so we can call files from the wd w/o explictly writing out the wd
data = read_xlsx("Data/CountyHealthRankingsData2022.xlsx", 4, skip = 1)

add_data = read_xlsx("Data/CountyHealthRankingsData2022.xlsx", 6, skip = 1)
```

```{r}
#remove features
#(: remove demographic info, CI: remove conf int, Quartile: remove quartile rankings)
#Note: May want to consider demographic features

new_data = select(data, -contains(c("CI", "Quartile"), ignore.case = F))

new_add_data = select(add_data, -contains(c("CI", "Quartile"), ignore.case = F))
```

```{r}
#note: first row of a state is aggregated/averaged information at the state level
#note: Other rows are simply aggregated at the county level
comb_data = inner_join(new_data, new_add_data, by = c("FIPS", "State", "County"))

#Identify and remove rows with unreliable data (Issue: This may affect counts for state level data)

reliable_data = comb_data %>%
  mutate(na_id = as.numeric(is.na(comb_data$Unreliable...4))) %>% #binary to is.na
  filter(na_id == 1) #keep only rows w NA (reliable rows)

#Why don't these match up (there's a minor computational discrepancy to the +- 0.2 lvl)
comb_data %>%
  group_by(State) %>%
  slice(1) %>%
  summarise(a = `Life Expectancy`)

comb_data %>%
  group_by(State) %>%
  slice(-1) %>%
  summarise(a = sum(`Life Expectancy` * `Population`, na.rm = T),
            b = sum(`Population`, na.rm = T),
            c = a/b)

reliable_data %>%
  group_by(State) %>%
  slice(-1) %>%
  summarise(a = sum(`Life Expectancy` * `Population`, na.rm = T),
            b = sum(`Population`, na.rm = T),
            c = a/b)
```

# EDA

Note: Data is aggregated and therefore variables must be weighted by population when feasible. By deafult, many variables are weighted by population.

## Bivariate

Explore distribution of response and predictors

Response: "Years of Potential Life Lost Rate", "Life Expectancy"

Predictors: 

*Tobacco*
Adult Smoking: Percentage of adults who are current smokers (age-adjusted). (`% Smokers`)

*Sexual Activity*
Sexually Transmitted Infections: Number of newly diagnosed chlamydia cases per 100,000 population. (`# Chlamydia Cases`)

*Alcohol and Drug Use*
Excessive Drinking: Percentage of adults reporting binge or heavy drinking (age-adjusted). (`% Excessive Drinking`)

Alcohol-Impaired Driving Deaths: Percentage of driving deaths with alcohol involvement. (`% Driving Deaths with Alcohol Involvement`)

Drug Overdose Deaths*: Number of drug poisoning deaths per 100,000 population. (`# Drug Overdose Deaths`)

Motor Vehicle Crash Deaths*: Number of motor vehicle crash deaths per 100,000 population. (`# Motor Vehicle Deaths`)

*Diet and Exercise*
Adult Obesity: Percentage of the adult population (age 18 and older) that reports a body mass index (BMI) greater than or equal to 30 kg/m2 (age-adjusted). (`% Adults with Obesity`)

Food Environment Index: Index of factors that contribute to a healthy food environment, from 0 (worst) to 10 (best). (`Food Environment Index`)

Physical Inactivity: Percentage of adults age 18 and over reporting no leisure-time physical activity (age-adjusted). (`% Physically Inactive`)

Access to Exercise Opportunities: Percentage of population with adequate access to locations for physical activity. (`% With Access to Exercise Opportunities`)

Food Insecurity*: Percentage of population who lack adequate access to food. (`% Food Insecure`)

Limited Access to Healthy Foods*: Percentage of population who are low-income and do not live close to a grocery store. (`% Limited Access to Healthy Foods`)

### Response
```{r}
library(usmap)
library(ggplot2)

#State
state_df = reliable_data %>%
  group_by(State) %>%
  slice(1) %>%
  rename(., state = State, YPLL = 'Years of Potential Life Lost Rate', Life_Expectancy = 'Life Expectancy')

#YPLL (low values good)
plot_usmap(data = state_df, values = "YPLL", color = "black") + 
  scale_fill_continuous(name = "YPLL (2020)", low = "white", high = "red", 
                        label = scales::comma, limits = c(5000,11500)) + 
  theme(legend.position = "right") +
  labs(title = "")

plot_usmap(data = state_df, values = "YPLL", color = "black", include = .south_region) + #SPecify region
  scale_fill_continuous(name = "YPLL (2020)",  low = "white", high = "red",  
                        label = scales::comma, limits = c(5000,11500)) + 
  theme(legend.position = "right") +
  labs(title = "")

#Life Expectancy (low values bad --> color adjust across two plots)
# plot_usmap(data = state_df, values = "Life_Expectancy", color = "black") + 
#   scale_fill_continuous(low = "red", high = "white", name = "Life Expectancy (2020)", label = scales::comma) + 
#   theme(legend.position = "right") +
#   labs(title = "")
```

```{r}
#County
county_df = reliable_data %>%
  group_by(State) %>%
  slice(-1) %>%
  rename(., fips = FIPS, YPLL = 'Years of Potential Life Lost Rate', Life_Expectancy = 'Life Expectancy') #%>%
  #filter(Life_Expectancy < 100, YPLL < 25000)

#YPLL (low values good)
plot_usmap(data = county_df, values = "YPLL", color = "black") + 
  scale_fill_continuous(name = "YPLL (2020)",  low = "white", high = "red",  
                        label = scales::comma) + 
  theme(legend.position = "right") +
  labs(title = "")

#Life Expectancy (low values bad --> color adjust across two plots)
# plot_usmap(data = county_df, values = "Life_Expectancy", color = "black") + 
#   scale_fill_continuous(low = "red", high = "white", name = "Life Expectancy (2020)", label = scales::comma) + 
#   theme(legend.position = "right") +
#   labs(title = "")
```

#### Demographic

```{r}
#state level demo data
demo_response_df = reliable_data %>%
  group_by(State) %>%
  slice(1) %>%
  ungroup(State) %>%
  rename(., state = State, YPLL = 'Years of Potential Life Lost Rate', Life_Expectancy = 'Life Expectancy') %>%
  select(., contains(c("YPLL Rate (", "state")))

#Check unreliable demo ypll across states
# quick = function(x){x %>% is.na() %>% sum()}
# 
# demo_response_df %>%
#   select(., contains("Unreliable")) %>%
#   apply(., MARGIN = 2, FUN = quick)

#remove unreliable demo information
index = as.numeric(is.na(demo_response_df$`YPLL Rate (AIAN) Unreliable`))
demo_response_df$`YPLL Rate (AIAN)`[which(index == 0)] = NA

#long format data
demo_response_clean_df = demo_response_df %>%
  select(., -contains("Unreliable")) %>%
  pivot_longer(cols = !state,
               names_to = "Race", values_to = "YPLL")
```

```{r}
demo_map = function(df = demo_response_clean_df, Race_Type, limit_set = c()) {
  
  plot_usmap(data = filter(df, Race == Race_Type), values = "YPLL", color = "black") + 
  scale_fill_continuous(low = "white", high = "red", name = "YPLL (2020)", label = scales::comma, limits = limit_set) + 
  theme(legend.position = "right") +
  labs(title = Race_Type)
  
}

#Difficult to set standard limits because range varies significantly across demographic groups
demo_map(Race_Type = "YPLL Rate (AIAN)")
demo_map(Race_Type = "YPLL Rate (Asian)")
demo_map(Race_Type = "YPLL Rate (Black)")
demo_map(Race_Type = "YPLL Rate (Hispanic)")
demo_map(Race_Type = "YPLL Rate (white)")
```

### Predictors
#HELP: How to make function that takes variable name and outputs graph using ggplot

```{r}
test_func = function(df = state_df, var_name){ #Tidy eval helpers?
  ggplot(df, aes(x = var_name)) +
    geom_histogram()
}

#test_func(var_name = Deaths)
```

```{r}
#give each person a group of predictors to explore against the two potential predictors (e.g., Tobacco & Sex, Alcohol/Drug, Diet/Exercise)
#Explore demographic information for respective var (if available, I see only drug overdose across all health behavior var)
#Discuss appropriate graphs when plotting two continuous variables with aggregated data (how to reflect population in scatterplot?)
#Can scatterplot variables that control for population (e.g., proportion/%/per 100k)
```

#### Tobacco 

```{r}
tobacco_sex_df = reliable_data %>%
  group_by(State) %>%
  slice(1) %>%
  rename(., state = State, YPLL = 'Years of Potential Life Lost Rate') %>%
  summarise(smoke = `% Smokers`, std = `Chlamydia Rate`, YPLL)

#map
plot_usmap(data = tobacco_sex_df, values = "smoke", color = "black") + 
  scale_fill_continuous(name = "% Smokers (2020)",  low = "white", high = "red",  
                        label = scales::comma) + 
  theme(legend.position = "right") +
  labs(title = "")

#plot against YPLL
ggplot(tobacco_sex_df, aes(x = YPLL, y = smoke)) +
  geom_point(alpha = 0.5) + #geom_smooth(se = F, method = "lm") +
  theme_bw() +
  labs(title = "YPLL Increases As Smoking Prevelance Increases", x = "Years of Potential Life Lost (YPLL)", y = "% Smokers")

#cor(tobacco_sex_df$YPLL, tobacco_sex_df$smoke) #0.82
```

#### Sex

```{r}
#map
plot_usmap(data = tobacco_sex_df, values = "std", color = "black") + 
  scale_fill_continuous(name = "# Chlamydia Cases (2020)",  low = "white", high = "red",  
                        label = scales::comma) + 
  theme(legend.position = "right") +
  labs(title = "")

#plot against YPLL
ggplot(tobacco_sex_df, aes(x = std, y = smoke)) +
  geom_point(alpha = 0.5) + #geom_smooth(se = F, method = "lm") + #no relationship
  theme_bw() +
  labs(title = "No Relationship Between Smoking and STD Prevelance", x = "Chlamydia Rate", y = "% Smokers")

#plot against YPLL
ggplot(tobacco_sex_df, aes(x = YPLL, y = std)) +
  geom_point(alpha = 0.5) + #geom_smooth(se = F, method = "lm") + #weak positive relationship
  theme_bw() +
  labs(title = "YPLL Increases Slightly As STD Prevelance Increases", x = "Years of Potential Life Lost (YPLL)", y = "Chlamydia Rate")

#cor(tobacco_sex_df$YPLL, tobacco_sex_df$std) #0.3735421
```

## Multivariate




# Modeling

#HELP
What is my sample size using this aggregated data (also should I remove DC when doing scatterplots and building models)
DC Population bigger than some states
```{r}
#model assumptions
library(ggfortify)

simple_model = lm(YPLL ~ smoke + std, data = tobacco_sex_df)

autoplot(simple_model, ncol = 2) + theme_bw() #one or two outliers but otherwise pretty good

#Output
summary(simple_model) #this is actually pretty good and then x's seem to be independent of each other

#Due to potential violations of normality, (1) can try removing outliers, (2) use nonparametric regression
```



# Conclusions















