---
title: "Predictive Modeling"
output: html_document
date: '2022-06-29'
---

# Goal

Develop a model to predict length of life using Health Behaviors

Determine variable to define length of life.

Determine the mix of predictors (i.e., specific x's and categories).

# Data Documentation

```{r}
#(https://www.countyhealthrankings.org/explore-health-rankings/measures-data-sources/county-health-rankings-model?componentType=factor-area&componentId=3)
```

* Additional Measure (not included in ranks)

## Length of Life

Premature Death: Years of potential life (YPLL) lost before age 75 per 100,000 population (age-adjusted)

Life Expectancy: Average number of years a person can expect to live.

## Health Behaviors

*Tobacco*
Adult Smoking: Percentage of adults who are current smokers (age-adjusted).

*Sexual Activity*
Sexually Transmitted Infections: Number of newly diagnosed chlamydia cases per 100,000 population.

*Alcohol and Drug Use*
Excessive Drinking: Percentage of adults reporting binge or heavy drinking (age-adjusted).

Alcohol-Impaired Driving Deaths: Percentage of driving deaths with alcohol involvement.

Drug Overdose Deaths*: Number of drug poisoning deaths per 100,000 population.

Motor Vehicle Crash Deaths*: Number of motor vehicle crash deaths per 100,000 population.

*Diet and Exercise*
Adult Obesity: Percentage of the adult population (age 18 and older) that reports a body mass index (BMI) greater than or equal to 30 kg/m2 (age-adjusted).

Food Environment Index: Index of factors that contribute to a healthy food environment, from 0 (worst) to 10 (best). 

Physical Inactivity: Percentage of adults age 18 and over reporting no leisure-time physical activity (age-adjusted). 

Access to Exercise Opportunities: Percentage of population with adequate access to locations for physical activity.

Food Insecurity*: Percentage of population who lack adequate access to food.

Limited Access to Healthy Foods*: Percentage of population who are low-income and do not live close to a grocery store.

## Social and Economic Factors

*Employment*
Unemployment: Percentage of population ages 16 and older unemployed but seeking work.

*Education*
High School Completion: Percentage of adults ages 25 and over with a high school diploma or equivalent.

Some College: Percentage of adults ages 25-44 with some post-secondary education.

High School Graduation*: Percentage of ninth-grade cohort that graduates in four years.

*Income*
Income Inequality: Ratio of household income at the 80th percentile to income at the 20th percentile.

Median Household Income*: The income where half of households in a county earn more and half of households earn less.

Living Wage*: The hourly wage needed to cover basic household expenses plus all relevant taxes for a household of one adult and two children.

*Community Safety*
Violent Crime: Number of reported violent crime offenses per 100,000 population.

Injury Deaths: Number of deaths due to injury per 100,000 population.

Homicides*: Number of deaths due to homicide per 100,000 population.

Suicides*: Number of deaths due to suicide per 100,000 population (age-adjusted).

Firearm Fatalities*: Number of deaths due to firearms per 100,000 population.

Juvenile Arrests*: Rate of delinquency cases per 1,000 juveniles.

# Notes

```{r}
# Equity in ML
#(http://www.datasciencepublicpolicy.org/our-work/tools-guides/aequitas/)
```

# Read Data

```{r}
library(tidyverse)
library(readxl)
```

```{r, message=F, warning=F}
#r project establishes root wd so we can call files from the wd w/o explictly writing out the wd
data = read_xlsx("Data/CountyHealthRankingsData2022.xlsx", 4, skip = 1)

add_data = read_xlsx("Data/CountyHealthRankingsData2022.xlsx", 6, skip = 1)
```

```{r}
#remove features
#(: remove demographic info, CI: remove conf int, Quartile: remove quartile rankings)
#Note: May want to consider demographic features

new_data = select(data, -contains(c("CI", "Quartile"), ignore.case = F))

new_add_data = select(add_data, -contains(c("CI", "Quartile"), ignore.case = F))

comb_data = inner_join(new_data, new_add_data, by = c("FIPS", "State", "County"))
```


```{r}
#note: first row of a state is aggregated/averaged information at the state level
#note: Other rows are simply aggregated at the county level

#Identify and remove rows with unreliable data (Issue: This may affect counts for state level data)

reliable_data = comb_data %>%
  mutate(na_id = as.numeric(is.na(comb_data$Unreliable...4))) %>% #binary to is.na
  filter(na_id == 1) #keep only rows w NA (reliable rows)
```

```{r}
#Can Cluster by county attribute (on population lvl) (Population)
#County clustering (urban, suburban, rural) within state
#Capture county characteristics and state characteristics

#(https://www.hudexchange.info/faqs/programs/cdbg-entitlement-program/urban-county/where-is-the-term-urban-county-defined-within-the-cdbg-program-and-how/#:~:text=This%20provision%20defines%20an%20urban,including%20metropolitan%20cities%20located%20therein)
#(https://www.hhs.gov/guidance/document/defining-rural-population#:~:text=All%20counties%20that%20are%20not,as%20either%20Metro%20or%20Micro)
sub_upper_lim = 200000
sub_lower_lim = 50000

reliable_data = reliable_data %>%
  mutate(county_class = 
           case_when(Population < (sub_upper_lim) & Population >= (sub_lower_lim) ~ "Suburban",
                     Population >= (sub_upper_lim) ~ "Urban", 
                     TRUE ~ "Rural")) #%>% select(State, County, county_class, Population)
```

```{r,include=F}
#Comparing YPLL state aggregated calculations to see impact of removing unreliable county data
#Research what age-adjusted calculations do
#Why don't these match up (there's a minor computational discrepancy to the +- 0.2 lvl)
comb_data %>%
  group_by(State) %>%
  dplyr::slice(1) %>%
  summarise(a = `Years of Potential Life Lost Rate`)

comb_data %>%
  group_by(State) %>%
  dplyr::slice(-1) %>%
  summarise(a = sum(`Years of Potential Life Lost Rate` * `Population`, na.rm = T),
            b = sum(`Population`, na.rm = T),
            c = a/b)

reliable_data %>%
  group_by(State) %>%
  dplyr::slice(-1) %>%
  summarise(a = sum(`Years of Potential Life Lost Rate` * `Population`, na.rm = T),
            b = sum(`Population`, na.rm = T),
            c = a/b)
```

# EDA

Note: Data is aggregated and therefore variables must be weighted by population when feasible. By deafult, many variables are weighted by population.

Response: "Years of Potential Life Lost Rate" (YPLL)

Predictors: 

*Tobacco*
Adult Smoking: Percentage of adults who are current smokers (age-adjusted). (`% Smokers`)

*Sexual Activity*
Sexually Transmitted Infections: Number of newly diagnosed chlamydia cases per 100,000 population. (`# Chlamydia Cases`)

*Alcohol and Drug Use*
Excessive Drinking: Percentage of adults reporting binge or heavy drinking (age-adjusted). (`% Excessive Drinking`)

Alcohol-Impaired Driving Deaths: Percentage of driving deaths with alcohol involvement. (`% Driving Deaths with Alcohol Involvement`)

Drug Overdose Deaths*: Number of drug poisoning deaths per 100,000 population. (`# Drug Overdose Deaths`)

Motor Vehicle Crash Deaths*: Number of motor vehicle crash deaths per 100,000 population. (`# Motor Vehicle Deaths`)

*Diet and Exercise*
Adult Obesity: Percentage of the adult population (age 18 and older) that reports a body mass index (BMI) greater than or equal to 30 kg/m2 (age-adjusted). (`% Adults with Obesity`)

Food Environment Index: Index of factors that contribute to a healthy food environment, from 0 (worst) to 10 (best). (`Food Environment Index`)

Physical Inactivity: Percentage of adults age 18 and over reporting no leisure-time physical activity (age-adjusted). (`% Physically Inactive`)

Access to Exercise Opportunities: Percentage of population with adequate access to locations for physical activity. (`% With Access to Exercise Opportunities`)

Food Insecurity*: Percentage of population who lack adequate access to food. (`% Food Insecure`)

Limited Access to Healthy Foods*: Percentage of population who are low-income and do not live close to a grocery store. (`% Limited Access to Healthy Foods`)

## Response
```{r}
library(usmap)
library(ggplot2)

#State
state_df = reliable_data %>%
  group_by(State) %>%
  dplyr::slice(1) %>%
  rename(., state = State, YPLL = 'Years of Potential Life Lost Rate', Life_Expectancy = 'Life Expectancy')

#YPLL (low values good)
plot_usmap(data = state_df, values = "YPLL", color = "black") + 
  scale_fill_continuous(name = "YPLL (2020)", low = "white", high = "red", 
                        label = scales::comma, limits = c(5000,11500)) + 
  theme(legend.position = "right") +
  labs(title = "")

plot_usmap(data = state_df, values = "YPLL", color = "black", include = .south_region) + #SPecify region
  scale_fill_continuous(name = "YPLL (2020)",  low = "white", high = "red",  
                        label = scales::comma, limits = c(5000,11500)) + 
  theme(legend.position = "right") +
  labs(title = "")

#Life Expectancy (low values bad --> color adjust across two plots)
# plot_usmap(data = state_df, values = "Life_Expectancy", color = "black") + 
#   scale_fill_continuous(low = "red", high = "white", name = "Life Expectancy (2020)", label = scales::comma) + 
#   theme(legend.position = "right") +
#   labs(title = "")
```

```{r}
#County
county_df = reliable_data %>%
  group_by(State) %>%
  dplyr::slice(-1) %>%
  rename(., fips = FIPS, YPLL = 'Years of Potential Life Lost Rate', Life_Expectancy = 'Life Expectancy') #%>%
  #filter(Life_Expectancy < 100, YPLL < 25000)

#YPLL (low values good)
plot_usmap(data = county_df, values = "YPLL", color = "black") + 
  scale_fill_continuous(name = "YPLL (2020)",  low = "white", high = "red",  
                        label = scales::comma) + 
  theme(legend.position = "right") +
  labs(title = "")

#Life Expectancy (low values bad --> color adjust across two plots)
# plot_usmap(data = county_df, values = "Life_Expectancy", color = "black") + 
#   scale_fill_continuous(low = "red", high = "white", name = "Life Expectancy (2020)", label = scales::comma) + 
#   theme(legend.position = "right") +
#   labs(title = "")
```

### Demographic

```{r}
#state level demo data
demo_response_df = reliable_data %>%
  group_by(State) %>%
  dplyr::slice(1) %>%
  ungroup(State) %>%
  rename(., state = State, all_YPLL = 'Years of Potential Life Lost Rate', Life_Expectancy = 'Life Expectancy') %>%
  select(., contains(c("YPLL Rate (", "state", "all_YPLL")))

#Check unreliable demo ypll across states
# quick = function(x){x %>% is.na() %>% sum()}
# 
# demo_response_df %>%
#   select(., contains("Unreliable")) %>%
#   apply(., MARGIN = 2, FUN = quick)

#remove unreliable demo information
index = as.numeric(is.na(demo_response_df$`YPLL Rate (AIAN) Unreliable`))
demo_response_df$`YPLL Rate (AIAN)`[which(index == 0)] = NA

#long format data
demo_response_clean_df = demo_response_df %>%
  select(., -contains("Unreliable")) %>%
  pivot_longer(cols = !state,
               names_to = "Race", values_to = "YPLL")
```

```{r}
#function to get states from region for reactive plot
expand_region = function(x){
  
  states_expanded <- if(x == "Northeast"){
    c('Connecticut', 'New Jersey', 'New York', 'Pennsylvania', 'Maine', 'Massachusetts', 'New Hampshire', 'Rhode Island', 
    'Vermont')
    
    } else if(x == "Midwest"){
      c('Illinois', 'Indiana', 'Michigan', 'Ohio', 'Wisconsin', 'Iowa', 'Kansas', 'Minnesota', 'Missouri', 'Nebraska', 
    'North Dakota', 'South Dakota')
      
      } else if(x == "South"){
  c('Delaware', 'Florida', 'Georgia', 'Maryland', 'North Carolina', 'South Carolina', 'Virginia', 'District of Columbia', 
    'West Virginia', 'Alabama', 'Kentucky', 'Mississippi', 'Tennessee', 'Arkansas', 'Louisiana', 'Oklahoma', 'Texas')
        
        } else if(x == "West"){
  c('Arizona', 'Colorado', 'Idaho', 'Montana', 'Nevada', 'New Mexico', 'Utah', 'Wyoming', 'Alaska', 'California', 'Hawaii', 
    'Oregon', 'Washington')
        } else {c()} #All case
  
  states_expanded
}
```

```{r}
#Modify: cleaned race_type inputs based on shiny list, extra: regional input flexibility
demo_map = function(df = demo_response_clean_df, Race_Type, limit_set = c(), region = '') {
  
  #Filter readable input to variable name in df
  filter_input = case_when(
    Race_Type == "All" ~ "all_YPLL",
    Race_Type == "Asian" ~ "YPLL Rate (Asian)",
    Race_Type == "Black" ~ "YPLL Rate (Black)",
    Race_Type == "Hispanic" ~ "YPLL Rate (Hispanic)",
    Race_Type == "Native American" ~ "YPLL Rate (AIAN)",
    Race_Type == "White" ~ "YPLL Rate (white)"
  )
  
  #Expand region input so it is readable in plot
  filter_region = expand_region(region)

  plot_usmap(data = filter(df, Race == filter_input), values = "YPLL", color = "black", include = filter_region) + 
  scale_fill_continuous(low = "white", high = "red", name = "YPLL (2020)", label = scales::comma, limits = limit_set) + 
  theme(legend.position = "right",
        legend.key.size = unit(10, 'mm')) +
  labs(title = "") #Race_Type

}

#Difficult to set standard limits because range varies significantly across demographic groups
demo_map(Race_Type = "Asian", region = "West")
demo_map(Race_Type = "Native American", region = "South")
demo_map(Race_Type = "Black", region = "All")
demo_map(Race_Type = "Hispanic", region = "Northeast")
demo_map(Race_Type = "White", region = "Midwest")
demo_map(Race_Type = "All")
```

## Predictors

```{r, include=F}
test_func = function(df = state_df, var_name){ 
  
  ggplot(df, aes(x = get(var_name))) + #use get to transform char to var name
    geom_histogram()
}

test_func(var_name = "Deaths")
```

```{r}
#County Level
df = reliable_data %>%
  group_by(State, County) %>%
  rename(., state = State, YPLL = 'Years of Potential Life Lost Rate') %>%
  summarise(#alcohol/drug
            drink_per = `% Excessive Drinking`, dui_per = `% Driving Deaths with Alcohol Involvement`, 
            od_num = `# Drug Overdose Deaths`, vehicle_death = `# Motor Vehicle Deaths`, obesity_rate = `% Adults with Obesity`, 
            #food/exercise
            food_index = `Food Environment Index`, inactive_per = `% Physically Inactive`, 
            exercise_access_per = `% With Access to Exercise Opportunities`, food_per = `% Food Insecure`, 
            healthy_access_per = `% Limited Access to Healthy Foods`,
            #tobacco
            smoke = `% Smokers`, 
            #sex
            std = `Chlamydia Rate`, 
            #response
            YPLL) %>% 
  na.omit()

#Remove char col

num_df = df[ , !sapply(df, is.character)]

#Linear Correlation Matrix (Response vs Predictors)
lin_cor = cor(num_df, df[,length(df)]) %>% 
  round(., 3) %>% 
  as.data.frame() %>% 
  mutate(YPLL_abs = abs(YPLL)) %>%
  arrange(desc(YPLL_abs))
```

```{r, include = F}
#Dataframe with all the predictors
#Comparing county differences if we omit all NAs
no_na_pred_df = reliable_data %>%
  group_by(State, County) %>%
  rename(., state = State, YPLL = 'Years of Potential Life Lost Rate') %>%
  summarise(#alcohol/drug
            drink_per = `% Excessive Drinking`, dui_per = `% Driving Deaths with Alcohol Involvement`, 
            od_num = `# Drug Overdose Deaths`, vehicle_death = `# Motor Vehicle Deaths`, obesity_rate = `% Adults with Obesity`, 
            #food/exercise
            food_index = `Food Environment Index`, inactive_per = `% Physically Inactive`, 
            exercise_access_per = `% With Access to Exercise Opportunities`, food_per = `% Food Insecure`, 
            healthy_access_per = `% Limited Access to Healthy Foods`,
            #tobacco
            smoke = `% Smokers`, 
            #sex
            std = `Chlamydia Rate`, 
            #response
            YPLL) %>%
  na.omit()

county_df = reliable_data %>%
  group_by(State, County) %>%
  rename(., state = State, YPLL = 'Years of Potential Life Lost Rate') %>%
  summarise(#alcohol/drug
            drink_per = `% Excessive Drinking`, dui_per = `% Driving Deaths with Alcohol Involvement`, 
            od_num = `# Drug Overdose Deaths`, vehicle_death = `# Motor Vehicle Deaths`, obesity_rate = `% Adults with Obesity`, 
            #food/exercise
            food_index = `Food Environment Index`, inactive_per = `% Physically Inactive`, 
            exercise_access_per = `% With Access to Exercise Opportunities`, food_per = `% Food Insecure`, 
            healthy_access_per = `% Limited Access to Healthy Foods`,
            #tobacco
            smoke = `% Smokers`, 
            #sex
            std = `Chlamydia Rate`, 
            #response
            YPLL)

setdiff(county_df, no_na_pred_df) %>% #find rows not in subsetted df comparing to parent df
  is.na() %>% 
  colSums()
```

#### Tobacco 

```{r}
state_tobacco_sex_df = reliable_data %>%
  group_by(State) %>%
  dplyr::slice(1) %>%
  rename(., state = State, YPLL = 'Years of Potential Life Lost Rate') %>%
  summarise(smoke = `% Smokers`, std = `Chlamydia Rate`, YPLL)

county_tobacco_sex_df = reliable_data %>%
  group_by(State, County) %>%
  rename(., state = State, YPLL = 'Years of Potential Life Lost Rate') %>%
  summarise(county_class, smoke = `% Smokers`, std = `Chlamydia Rate`, YPLL, Population) %>%
  na.omit()

#map
plot_usmap(data = state_tobacco_sex_df, values = "smoke", color = "black") + 
  scale_fill_continuous(name = "% Smokers (2020)",  low = "white", high = "red",  
                        label = scales::comma) + 
  theme(legend.position = "right") +
  labs(title = "")

#plot against YPLL (State) cor = 0.82
ggplot(state_tobacco_sex_df, aes(y = YPLL, x = smoke)) +
  geom_point(alpha = 0.25) + #geom_smooth(se = F, method = "lm") +
  theme_bw() +
  labs(title = "YPLL Increases As Smoking Prevelance Increases", y = "Years of Potential Life Lost (YPLL)", x = "% Smokers")

#plot against YPLL (County) cor = 0.74
ggplot(county_tobacco_sex_df, aes(x = YPLL, y = smoke, color = county_class)) +
  geom_point(alpha = 0.25) + #geom_smooth(se = F, method = "lm") +
  theme_bw() +
  geom_smooth(method = "lm", se = F) +
  labs(title = "YPLL Increases As Smoking Prevelance Increases", x = "Years of Potential Life Lost (YPLL)", y = "% Smokers",
       color = "County Class")
```

#### Sex

```{r}
#map
plot_usmap(data = state_tobacco_sex_df, values = "std", color = "black") + 
  scale_fill_continuous(name = "# Chlamydia Cases (2020)",  low = "white", high = "red",  
                        label = scales::comma) + 
  theme(legend.position = "right") +
  labs(title = "")

#plot against smoke (State)
ggplot(state_tobacco_sex_df, aes(x = std, y = smoke)) +
  geom_point(alpha = 0.25) + geom_smooth(se = F, method = "lm") + #no relationship
  theme_bw() +
  labs(title = "No Relationship Between Smoking and STD Prevelance", x = "Chlamydia Rate", y = "% Smokers")

#plot against smoke (County)
ggplot(county_tobacco_sex_df, aes(x = std, y = smoke, color = county_class)) +
  geom_point(alpha = 0.25) + geom_smooth(se = F, method = "lm") + #no relationship
  theme_bw() +
  labs(title = "County Level By Class Suggests Relationship", x = "Chlamydia Rate", y = "% Smokers", color = "County Class")

#plot against YPLL (State) cor = 0.37
ggplot(state_tobacco_sex_df, aes(y = YPLL, x = std)) +
  geom_point(alpha = 0.25) + geom_smooth(se = F, method = "lm") + #weak positive relationship
  theme_bw() +
  labs(title = "YPLL Increases Slightly As Chlamydia Rate Increases", x = "Years of Potential Life Lost (YPLL)", y = "Chlamydia Rate")

#plot against YPLL (County) cor = 0.24
ggplot(county_tobacco_sex_df, aes(y = YPLL, x = std, color = county_class)) +
  geom_point(alpha = 0.25) + geom_smooth(se = F, method = "lm") +
  theme_bw() +
  labs(title = "YPLL Increases Slightly As Chlamydia Rate Increases", x = "Years of Potential Life Lost (YPLL)", y = "Chlamydia Rate", 
       color = "County Class")
```

#### Alcohol/Drug & Diet/Exercise

```{r}
county_pred_df = reliable_data %>%
  group_by(State, County) %>%
  rename(., state = State, YPLL = 'Years of Potential Life Lost Rate') %>%
  summarise(
            #Alcohol/Drug
            drink_per = `% Excessive Drinking`, dui_per = `% Driving Deaths with Alcohol Involvement`, 
            #od_num = `# Drug Overdose Deaths`, vehicle_death = `# Motor Vehicle Deaths`, #remove
            #food/exercise
            food_index = `Food Environment Index`, inactive_per = `% Physically Inactive`, 
            exercise_access_per = `% With Access to Exercise Opportunities`, food_per = `% Food Insecure`, 
            healthy_access_per = `% Limited Access to Healthy Foods`, obesity_rate = `% Adults with Obesity`,
            #tobacco
            smoke = `% Smokers`,
            #sex
            std = `Chlamydia Rate`,
            #response
            YPLL,
            #Cluster
            county_class = as.factor(county_class),
            #Population
            Population) %>%
  na.omit() 

library(GGally)

county_num_df = county_pred_df[ ,!sapply(county_pred_df, is.character)] %>%
  relocate(YPLL, .before = drink_per)

# end = length(county_num_df)
# half = (end/2) %>% ceiling()
# 
# ggpairs(county_num_df[,c(1:half)])
# ggpairs(county_num_df[,c(1,half:end)])
# cor(county_num_df[,-c(end-1,)]) %>% round(2)
```

# Modeling

## Variable Selection

Lasso, Ridge, Elastic Net (Deal with correlation especially across diet/exercise related variables)

```{r}
library(glmnet)

#convert data to x and y matrices
dummy_df = county_num_df %>%
  mutate(urban = ifelse(county_class == 'Urban', 1, 0),
         suburban = ifelse(county_class == 'Suburban', 1, 0),
         rural = ifelse(county_class == 'Rural', 1, 0)) %>%
  select(-county_class)

x_matrix = dummy_df %>% #how is county_class being treated in regularization techniques
  select(-c(YPLL)) %>% 
  as.matrix()

y_matrix = county_pred_df$YPLL
```

```{r, include=F}
#Initial lm
library(broom)

init_reg_fit <- lm(YPLL ~ ., dummy_df)

tidy(init_reg_fit) %>%
  mutate(coef_sign = as.factor(sign(estimate)),
         term = fct_reorder(term, estimate)) %>%
  ggplot(aes(x = term, y = estimate, fill = coef_sign)) +
  geom_bar(stat = "identity", color = "white") +
  scale_fill_manual(values = c("darkred", "darkblue"), 
                    guide = FALSE) +
  coord_flip() + 
  theme_bw()
```

```{r, include=F}
#Ridge
#Shrinkage Plot
init_ridge_fit <- glmnet(x_matrix, y_matrix, alpha = 0)#<<
plot(init_ridge_fit, xvar = "lambda")

#Lamda Tuning Plot
fit_ridge_cv <- cv.glmnet(x_matrix, y_matrix, alpha = 0) #<<
plot(fit_ridge_cv)

#Coefficient
tidy_ridge_coef <- tidy(fit_ridge_cv$glmnet.fit)

tidy_ridge_coef %>%
  filter(lambda == fit_ridge_cv$lambda.1se) %>%
  mutate(coef_sign = as.factor(sign(estimate)),
         term = fct_reorder(term, estimate)) %>%
  ggplot(aes(x = term, y = estimate, fill = coef_sign)) +
  geom_bar(stat = "identity", color = "white") +
  scale_fill_manual(values = c("darkred", "darkblue"), guide = "none") +
  coord_flip() + 
  theme_bw()
```

```{r, include=F}
#Lasso
fit_lasso_cv <- cv.glmnet(x_matrix, y_matrix, 
                          alpha = 1) #<<
plot(fit_lasso_cv)

tidy_lasso_coef <- tidy(fit_lasso_cv$glmnet.fit)

tidy_lasso_coef %>%
  ggplot(aes(x = lambda, y = estimate, 
             group = term)) +
  scale_x_log10() +
  geom_line(alpha = 0.75) +
  geom_vline(xintercept = 
               fit_lasso_cv$lambda.min) +
  geom_vline(xintercept = 
               fit_lasso_cv$lambda.1se, 
             linetype = "dashed", color = "red") +
  theme_bw()

tidy_lasso_cv <- tidy(fit_lasso_cv)

tidy_lasso_cv %>%
  ggplot(aes(x = lambda, y = nzero)) +
  geom_line() +
  geom_vline(xintercept = fit_lasso_cv$lambda.min) +
  geom_vline(xintercept = fit_lasso_cv$lambda.1se, 
             linetype = "dashed", color = "red") +
  scale_x_log10() + theme_bw()

tidy_lasso_coef %>%
  filter(lambda == fit_lasso_cv$lambda.1se) %>%
  mutate(coef_sign = as.factor(sign(estimate)),
         term = fct_reorder(term, estimate)) %>%
  ggplot(aes(x = term, y = estimate, 
             fill = coef_sign)) +
  geom_bar(stat = "identity", color = "white") +
  scale_fill_manual(values = c("darkred", "darkblue"), 
                    guide = 'none') +
  coord_flip() +
  theme_bw()
```

```{r}
#Compare Model Performances based on test RMSE
set.seed(1)
cv_df <- dummy_df %>% mutate(test_fold = sample(rep(1:5, length.out = n())))

holdout_predictions <- 
  map_dfr(unique(cv_df$test_fold), 
          
          function(holdout) {
            # Separate test and training data:
            test_data <- cv_df %>% filter(test_fold == holdout)
            train_data <- cv_df %>% filter(test_fold != holdout)
            
            # Repeat for matrices
            test_x <- as.matrix(dplyr::select(test_data, -YPLL))
            train_x <- as.matrix(dplyr::select(train_data, -YPLL))

            # Train models:
            lm_model <- lm(YPLL ~ ., data = train_data)
            ridge_model <- cv.glmnet(train_x, train_data$YPLL, alpha = 0)
            lasso_model <- cv.glmnet(train_x, train_data$YPLL, alpha = 1)
            en_model <- cv.glmnet(train_x, train_data$YPLL, alpha = .5)

            # Return tibble of holdout results:
            tibble(lm_preds = predict(lm_model, newdata = test_data), #linear model
                   ridge_preds = as.numeric(predict(ridge_model, newx = test_x)), #ridge
                   lasso_preds = as.numeric(predict(lasso_model, newx = test_x)), #lasso
                   en_preds = as.numeric(predict(en_model, newx = test_x)), #elastic net
                   test_actual = test_data$YPLL, test_fold = holdout) 
          })

holdout_predictions %>%
  pivot_longer(lm_preds:en_preds, 
               names_to = "type", values_to = "test_preds") %>%
  group_by(type, test_fold) %>%
  summarize(rmse = sqrt(mean((test_actual - test_preds)^2))) %>% 
  ggplot(aes(x = type, y = rmse)) + 
  geom_point() + theme_bw() +
  stat_summary(fun = mean, geom = "point", 
               color = "red") + 
  stat_summary(fun.data = mean_se, geom = "errorbar",
               color = "red")
```

## Model Design

### Linear Regression Model

```{r}
library(ggfortify)

#Aggregated data: Underestimates variability, Inflated SE, Inflated R^2
lm_mod = lm(YPLL ~ std + smoke + food_per + drink_per + county_class, data = county_num_df)

#autoplot(lm_mod, ncol = 2) + theme_bw() #mod assumptions

summary(lm_mod) #Output
```

### Mixed Effects Model

```{r}
library(lme4) #mixed model library

#(1 | county_class) allows the intercept to vary by county_class, Random intercept model
mixed_mod = lmer(YPLL ~ std + smoke + food_per + (1 | county_class), data = county_num_df)

#Random slope model (#random slope look for group structure in y vs x)
#mixed_mod = lmer(YPLL ~ smoke + std + (smoke | county_class), data = county_tobacco_sex_df)

#Random slope and random intercept model
#mixed_mod = lmer(YPLL ~ smoke + std + (1 + smoke | county_class), data = county_tobacco_sex_df)

summary(mixed_mod) #why fixed effects are dif than in linear mod
```

### GAM

```{r}
library(caret)
library(mgcv)

#Train/Test Data
set.seed(1)
parts = createDataPartition(county_num_df$YPLL, p = .7, list = F) #70/30 split
train = county_num_df[parts, ]
test = county_num_df[-parts, ]

test_x = select(test, -YPLL) # feature and target array
test_y = select(test, YPLL)

#Train gam model
#Tuning Parameters: Number of basis functions, # knots
gam_model = gam(YPLL ~ s(drink_per) + s(dui_per) + s(food_index) + s(inactive_per) + s(exercise_access_per) + s(food_per) + 
                  s(healthy_access_per) + s(obesity_rate) + s(smoke) + s(std) + as.factor(county_class), 
                data = train, 
                method = "REML")

summary(gam_model)
```


### Tree Based Model

```{r}
#Given the linear relationships in the data, the tree based method didn't outperform lm and under performed GAM
library(gbm)

#Train GBM Model
model_gbm = gbm(train$YPLL ~.,
                data = train,
                distribution = "gaussian",
                cv.folds = 10,
                shrinkage = .1,
                n.minobsinnode = 10,
                n.trees = 250,
                verbose = F)
 
#print(model_gbm)

summary(model_gbm)

# #Test Set Predictions
# pred_y = predict.gbm(model_gbm, test_x)
# 
# #Calculate LOSS
# residuals = test_y - pred_y
# RMSE = residuals^2 %>% unlist() %>% as.numeric() %>% mean() %>% sqrt()
# RMSE
```

## Model Validation

Perform k-Fold CV on counties within States to limit the chance of having a fold over or under representing a particular state
e.g., randomly assign 1:5 across all counties within each state

```{r}
#stratified k fold
strat_cv = function(k = 5, seed = 123){
  
  set.seed(seed)
  state_list = unique(county_pred_df$state)
  strat_df = data.frame()

  for (i in 1:length(state_list)){
    df = filter(county_pred_df, state == state_list[i])
    new_df = mutate(df, test_fold = sample(1:k, replace = T, size = nrow(df)))
    strat_df = rbind(strat_df, new_df)
  }
  
  strat_df %>% ungroup() %>% select(-c(state, County))
}

strat_cv_df = strat_cv(5)

#Calculate holdout predictions
holdout_predictions <- 
  map_dfr(unique(strat_cv_df$test_fold), 
          
          function(holdout) {
            # Separate test and training data:
            test_data <- strat_cv_df %>% filter(test_fold == holdout)
            train_data <- strat_cv_df %>% filter(test_fold != holdout)
          
            # Train models:
            lm_model <- lm(YPLL ~ ., data = train_data)
            simple_lm_model <- lm(YPLL ~ std + smoke + food_per + drink_per + county_class, data = train_data)
            gam_model <- gam(YPLL ~ s(drink_per) + s(dui_per) + s(food_index) + s(inactive_per) + s(exercise_access_per) + s(food_per) +
                            s(healthy_access_per) + s(obesity_rate) + s(smoke) + s(std) + as.factor(county_class), 
                            data = train_data, 
                            method = "REML")
            pop_gam_model <-  gam(YPLL ~ s(inactive_per) + s(obesity_rate) + s(food_per) + s(drink_per) + s(smoke) + s(std) +
                                     s(Population),
                                     data = train_data, 
                                     method = "REML")
            simple_gam_model <-  gam(YPLL ~ s(inactive_per) + s(obesity_rate) + s(food_per) + s(drink_per) + s(smoke) + s(std) +
                                     as.factor(county_class),
                                     data = train_data, 
                                     method = "REML")

            # Return tibble of holdout results:
            tibble(lm_preds = predict(lm_model, newdata = test_data), #linear model
                   simple_lm_preds = predict(simple_lm_model, newdata = test_data),
                   gam_preds = predict(gam_model, newdata = test_data), #gam model
                   pop_gam_preds = predict(pop_gam_model, newdata = test_data),
                   simple_gam_preds = predict(simple_gam_model, newdata = test_data),
                   test_actual = test_data$YPLL, test_fold = holdout)
          })

holdout_predictions %>%
  pivot_longer(lm_preds:simple_gam_preds, 
               names_to = "type", values_to = "test_preds") %>%
  group_by(type, test_fold) %>%
  summarize(rmse = sqrt(mean((test_actual - test_preds)^2))) %>% 
  ggplot(aes(x = type, y = rmse)) + 
  geom_point() + theme_bw() +
  stat_summary(fun = mean, geom = "point", 
               color = "red") + 
  stat_summary(fun.data = mean_se, geom = "errorbar",
               color = "red") +
  labs(y = "RMSE", x = "Model Type")
```

Simple gam (7 features) performs outperforms gam with all 11 features within intervals. For simplicity and performance in potential Shiny App interface simple gam seems to be the way to go.

Interesting is that population instead of county_class outperforms very slightly, which is to be expected especially in GAM bc we lose some variability in information when transforming population to 3 county classes


#HELPPP: I tested models using df w p parameters and the df was filtered w na.omit on all p. But i settled on a model with p-4 parameters, so can I refilter my dataframe so it only na.omit on those p-4 parameters? (difference of ~80 obs)? Discuss using county class rather than population? How can I do variable importance plot with gam?
```{r}
library(hablar)

#Final model df
final_df = reliable_data %>%
  group_by(State, County) %>%
  rename(., state = State, YPLL = 'Years of Potential Life Lost Rate') %>%
  summarise(
            #Alcohol/Drug
            drink_per = `% Excessive Drinking`, 
            #food/exercise
            inactive_per = `% Physically Inactive`, 
            food_per = `% Food Insecure`, 
            obesity_rate = `% Adults with Obesity`,
            #tobacco
            smoke = `% Smokers`,
            #sex
            std = `Chlamydia Rate`,
            #response
            YPLL,
            #Cluster
            county_class = as.factor(county_class),
            #Population
            Population) %>%
  na.omit()

#Finalized model
final_gam_model <- gam(YPLL ~ s(inactive_per) + s(obesity_rate) + s(food_per) + s(drink_per) + s(smoke) + s(std) +
                         as.factor(county_class), #alternative: s(Population)
                      data = final_df, 
                      method = "REML")

summary(final_gam_model)

# Test the df read in for predict in shiny
# test_var = c(35.2, 25.11, "Urban", 14.44, 15.11, 40, 500)
# 
# test_names = c("inactive_per", "obesity_rate", "county_class", "food_per", "drink_per", "smoke", "std")
# 
# test_df = data.frame(matrix(nrow = 1, test_var)) %>% 
#   retype() #smart guess of appropriate classes
# 
# colnames(test_df) = test_names
# 
# predict(final_gam_model, newdata = test_df)
```

# Conclusions

# To Do: (1) Get year labels on all features, (2) Shiny App, (3) Formalize EDA, Methods and Conclusions, (4) Publish Shiny 

For EDA, show YPLL map distribution then show relationship with predictors (e.g., smoke, food) then show relationship between predictors to demonstrate some independence but also some correlation (especially between the food predictors). Then go to methods practices

# Shiny App

#HELP: Should I add VIP for GAM model in pred panel, change size of tabpanel titles
```{r}
library(shiny)
library(shinyBS)
library(bslib)

county_options = c("Urban", "Suburban", "Rural") %>% sort()
demo_options = c("All", "Asian", "Black", "Hispanic", "Native American", "White") %>% sort()
region_options = c('All',"Northeast", "Midwest", "South", "West") %>% sort()
df_names = c("county_class", "inactive_per", "obesity_rate", "food_per", "drink_per", "smoke", "std")
```

```{r}
#Modify tabpanel title height x width (CSS needed)
ui = navbarPage(title = div(img(
  
  src = "https://512solutions.com/wp-content/uploads/2021/04/Optum-logo.png", height = 55, width = 190), ""),
  
  theme = bs_theme(bootswatch = "lux"),
  
          tags$head(
           tags$style(HTML('.navbar-nav > li > a, .navbar-brand {
                            padding-top:4px !important; 
                            padding-bottom:0 !important;
                            height: 65px;
                            }')) #Alter height of navbarpage using CSS
         ),
                
      tabPanel(title = "Predictive Modeling",
                tags$style(HTML(".tabbable tabs-above > .nav > li > a {
                                background-color: aqua;  
                                color:black}")),
    
           fluidPage(
            
             titlePanel(title = h2("Premature Deaths Prediction", align = "center")),
              
             sidebarLayout(
               
             sidebarPanel( 
                selectInput(inputId = "county_class", label = "County Type:", choices = county_options),
                numericInput(inputId = "inactive_per", label = "Inactivity %:", value = 0, min = 0, max = 100, step = 0.1),
                numericInput(inputId = "obesity_rate", label = "Obesity %:", value = 0, min = 0, max = 100, step = 0.1),
                numericInput(inputId = "food_per", label = "Food Insecure %:", value = 0, min = 0, max = 100, step = 0.1),
                numericInput(inputId = "drink_per", label = "Physically Inactive %:", value = 0, min = 0, max = 100, step = 0.1),
                numericInput(inputId = "smoke", label = "Smoking %:", value = 0, min = 0, max = 100, step = 0.1),
                numericInput(inputId = "std", label = "Chlamydia Cases:", value = 0, min = 0, max = 5000, step = 0.1),
                
                actionButton(inputId = "go", label = "Predict"),
                
                bsTooltip(id = "county_class", title = "County Description"),
                bsTooltip(id = "inactive_per", title = "% of Adults Reporting No Leisure Time Physical Activity"),
                bsTooltip(id = "obesity_rate", title = "% of Adults with BMI > 30"),
                bsTooltip(id = "food_per", title = "% of Population With Poor Access to Food"),
                bsTooltip(id = "drink_per", title = "% of Adults Reporting Binge/Heavy Drinking"),
                bsTooltip(id = "smoke", title = "% of Adults Smoking Tobacco"),
                bsTooltip(id = "std", title = "Number of Chlamydia Cases per 100k")
             ),
             
            mainPanel(uiOutput("text1"),
              tags$head(tags$style("#text1{color: black;
                                 font-size: 20px;
                                 line-height: 5.0;
                                 text-indent: 20px;
                                 }"
                         )))

             ))),
  
    tabPanel(title = "Interactive Map",
             
    fluidPage(
        
        titlePanel(title = h2("Premature Deaths Map", align = "center")),
        
        sidebarLayout(
        sidebarPanel( 
            selectInput(inputId = "demo", label = "Race:", choices = demo_options),
            selectInput(inputId = "region", label = "Region:", choices = region_options) #optional addition
            ),
      
        mainPanel(
          plotOutput("plot1"))
        ))         
             
  ))
```

```{r}
server = function(input,output){
  
  #store inputs
  x_value <- reactive({
    c(input$county_class, input$inactive_per, input$obesity_rate, input$food_per, input$drink_per, input$smoke, input$std)
  })
  
  #convert inputs to dataframe
  shiny_df <- reactive({
    new_table = data.frame((matrix(nrow = 1, data = x_value()))) %>% retype()
    colnames(new_table) = df_names #get appropriate colnames
    new_table
  })
  
  #Get predictions
  shiny_pred <- reactive({
    predict(final_gam_model, newdata = shiny_df()) %>% round(2)
  })
  
  #Text output
  pred_reactive <- eventReactive(input$go, #put the expected YPLL text together
    {
      paste("The expected county YPLL per 100k is:", shiny_pred(), "Years")
  })
  
  output$text1 <- renderUI({pred_reactive()})
  
  #Plot output
  output$plot1 <- renderPlot({
    
    demo_map(Race_Type = input$demo, region = input$region)
  }, 
  height = 650, width = 1100)
  
}
```

```{r}
#run app
shinyApp(ui = ui, server = server)
```







