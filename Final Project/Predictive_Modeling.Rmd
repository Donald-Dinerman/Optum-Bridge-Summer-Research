---
title: "Predictive Modeling"
output: html_document
date: '2022-06-29'
---

# Goal

Develop a model to predict length of life using Health Behaviors

Determine variable to define length of life.

Determine the mix of predictors (i.e., specific x's and categories).

# Data Documentation

```{r}
#(https://www.countyhealthrankings.org/explore-health-rankings/measures-data-sources/county-health-rankings-model?componentType=factor-area&componentId=3)
```

* Additional Measure (not included in ranks)

## Length of Life

Premature Death: Years of potential life (YPLL) lost before age 75 per 100,000 population (age-adjusted)

Life Expectancy: Average number of years a person can expect to live.

## Health Behaviors

*Tobacco*
Adult Smoking: Percentage of adults who are current smokers (age-adjusted).

*Sexual Activity*
Sexually Transmitted Infections: Number of newly diagnosed chlamydia cases per 100,000 population.

*Alcohol and Drug Use*
Excessive Drinking: Percentage of adults reporting binge or heavy drinking (age-adjusted).

Alcohol-Impaired Driving Deaths: Percentage of driving deaths with alcohol involvement.

Drug Overdose Deaths*: Number of drug poisoning deaths per 100,000 population.

Motor Vehicle Crash Deaths*: Number of motor vehicle crash deaths per 100,000 population.

*Diet and Exercise*
Adult Obesity: Percentage of the adult population (age 18 and older) that reports a body mass index (BMI) greater than or equal to 30 kg/m2 (age-adjusted).

Food Environment Index: Index of factors that contribute to a healthy food environment, from 0 (worst) to 10 (best). 

Physical Inactivity: Percentage of adults age 18 and over reporting no leisure-time physical activity (age-adjusted). 

Access to Exercise Opportunities: Percentage of population with adequate access to locations for physical activity.

Food Insecurity*: Percentage of population who lack adequate access to food.

Limited Access to Healthy Foods*: Percentage of population who are low-income and do not live close to a grocery store.

## Social and Economic Factors

*Employment*
Unemployment: Percentage of population ages 16 and older unemployed but seeking work.

*Education*
High School Completion: Percentage of adults ages 25 and over with a high school diploma or equivalent.

Some College: Percentage of adults ages 25-44 with some post-secondary education.

High School Graduation*: Percentage of ninth-grade cohort that graduates in four years.

*Income*
Income Inequality: Ratio of household income at the 80th percentile to income at the 20th percentile.

Median Household Income*: The income where half of households in a county earn more and half of households earn less.

Living Wage*: The hourly wage needed to cover basic household expenses plus all relevant taxes for a household of one adult and two children.

*Community Safety*
Violent Crime: Number of reported violent crime offenses per 100,000 population.

Injury Deaths: Number of deaths due to injury per 100,000 population.

Homicides*: Number of deaths due to homicide per 100,000 population.

Suicides*: Number of deaths due to suicide per 100,000 population (age-adjusted).

Firearm Fatalities*: Number of deaths due to firearms per 100,000 population.

Juvenile Arrests*: Rate of delinquency cases per 1,000 juveniles.

# Notes

```{r}
# Equity in ML
#(http://www.datasciencepublicpolicy.org/our-work/tools-guides/aequitas/)
```

# Read Data

```{r}
library(tidyverse)
library(readxl)
```

```{r, message=F, warning=F}
#r project establishes root wd so we can call files from the wd w/o explictly writing out the wd
data = read_xlsx("Data/CountyHealthRankingsData2022.xlsx", 4, skip = 1)

add_data = read_xlsx("Data/CountyHealthRankingsData2022.xlsx", 6, skip = 1)
```

```{r}
#remove features
#(: remove demographic info, CI: remove conf int, Quartile: remove quartile rankings)
#Note: May want to consider demographic features

new_data = select(data, -contains(c("CI", "Quartile"), ignore.case = F))

new_add_data = select(add_data, -contains(c("CI", "Quartile"), ignore.case = F))

comb_data = inner_join(new_data, new_add_data, by = c("FIPS", "State", "County"))
```


```{r}
#note: first row of a state is aggregated/averaged information at the state level
#note: Other rows are simply aggregated at the county level

#Identify and remove rows with unreliable data (Issue: This may affect counts for state level data)

reliable_data = comb_data %>%
  mutate(na_id = as.numeric(is.na(comb_data$Unreliable...4))) %>% #binary to is.na
  filter(na_id == 1) #keep only rows w NA (reliable rows)
```

```{r}
#Can Cluster by county attribute (on population lvl) (Population)
#County clustering (urban, suburban, rural) within state
#Capture county characteristics and state characteristics

#(https://www.hudexchange.info/faqs/programs/cdbg-entitlement-program/urban-county/where-is-the-term-urban-county-defined-within-the-cdbg-program-and-how/#:~:text=This%20provision%20defines%20an%20urban,including%20metropolitan%20cities%20located%20therein)
#(https://www.hhs.gov/guidance/document/defining-rural-population#:~:text=All%20counties%20that%20are%20not,as%20either%20Metro%20or%20Micro)
sub_upper_lim = 200000
sub_lower_lim = 50000

reliable_data = reliable_data %>%
  mutate(county_class = 
           case_when(Population < (sub_upper_lim) & Population >= (sub_lower_lim) ~ "Suburban",
                     Population >= (sub_upper_lim) ~ "Urban", 
                     TRUE ~ "Rural")) #%>% select(State, County, county_class, Population)

reliable_data %>%
  group_by(State, county_class) %>%
  summarise(smoke = round(mean(`% Smokers`), 2))
```

```{r,include=F}
#Comparing YPLL state aggregated calculations to see impact of removing unreliable county data
#Research what age-adjusted calculations do
#Why don't these match up (there's a minor computational discrepancy to the +- 0.2 lvl)
comb_data %>%
  group_by(State) %>%
  slice(1) %>%
  summarise(a = `Years of Potential Life Lost Rate`)

comb_data %>%
  group_by(State) %>%
  slice(-1) %>%
  summarise(a = sum(`Years of Potential Life Lost Rate` * `Population`, na.rm = T),
            b = sum(`Population`, na.rm = T),
            c = a/b)

reliable_data %>%
  group_by(State) %>%
  slice(-1) %>%
  summarise(a = sum(`Years of Potential Life Lost Rate` * `Population`, na.rm = T),
            b = sum(`Population`, na.rm = T),
            c = a/b)
```

# EDA

Note: Data is aggregated and therefore variables must be weighted by population when feasible. By deafult, many variables are weighted by population.

Response: "Years of Potential Life Lost Rate" (YPLL)

Predictors: 

*Tobacco*
Adult Smoking: Percentage of adults who are current smokers (age-adjusted). (`% Smokers`)

*Sexual Activity*
Sexually Transmitted Infections: Number of newly diagnosed chlamydia cases per 100,000 population. (`# Chlamydia Cases`)

*Alcohol and Drug Use*
Excessive Drinking: Percentage of adults reporting binge or heavy drinking (age-adjusted). (`% Excessive Drinking`)

Alcohol-Impaired Driving Deaths: Percentage of driving deaths with alcohol involvement. (`% Driving Deaths with Alcohol Involvement`)

Drug Overdose Deaths*: Number of drug poisoning deaths per 100,000 population. (`# Drug Overdose Deaths`)

Motor Vehicle Crash Deaths*: Number of motor vehicle crash deaths per 100,000 population. (`# Motor Vehicle Deaths`)

*Diet and Exercise*
Adult Obesity: Percentage of the adult population (age 18 and older) that reports a body mass index (BMI) greater than or equal to 30 kg/m2 (age-adjusted). (`% Adults with Obesity`)

Food Environment Index: Index of factors that contribute to a healthy food environment, from 0 (worst) to 10 (best). (`Food Environment Index`)

Physical Inactivity: Percentage of adults age 18 and over reporting no leisure-time physical activity (age-adjusted). (`% Physically Inactive`)

Access to Exercise Opportunities: Percentage of population with adequate access to locations for physical activity. (`% With Access to Exercise Opportunities`)

Food Insecurity*: Percentage of population who lack adequate access to food. (`% Food Insecure`)

Limited Access to Healthy Foods*: Percentage of population who are low-income and do not live close to a grocery store. (`% Limited Access to Healthy Foods`)

## Response
```{r}
library(usmap)
library(ggplot2)

#State
state_df = reliable_data %>%
  group_by(State) %>%
  slice(1) %>%
  rename(., state = State, YPLL = 'Years of Potential Life Lost Rate', Life_Expectancy = 'Life Expectancy')

#YPLL (low values good)
plot_usmap(data = state_df, values = "YPLL", color = "black") + 
  scale_fill_continuous(name = "YPLL (2020)", low = "white", high = "red", 
                        label = scales::comma, limits = c(5000,11500)) + 
  theme(legend.position = "right") +
  labs(title = "")

plot_usmap(data = state_df, values = "YPLL", color = "black", include = .south_region) + #SPecify region
  scale_fill_continuous(name = "YPLL (2020)",  low = "white", high = "red",  
                        label = scales::comma, limits = c(5000,11500)) + 
  theme(legend.position = "right") +
  labs(title = "")

#Life Expectancy (low values bad --> color adjust across two plots)
# plot_usmap(data = state_df, values = "Life_Expectancy", color = "black") + 
#   scale_fill_continuous(low = "red", high = "white", name = "Life Expectancy (2020)", label = scales::comma) + 
#   theme(legend.position = "right") +
#   labs(title = "")
```

```{r}
#County
county_df = reliable_data %>%
  group_by(State) %>%
  slice(-1) %>%
  rename(., fips = FIPS, YPLL = 'Years of Potential Life Lost Rate', Life_Expectancy = 'Life Expectancy') #%>%
  #filter(Life_Expectancy < 100, YPLL < 25000)

#YPLL (low values good)
plot_usmap(data = county_df, values = "YPLL", color = "black") + 
  scale_fill_continuous(name = "YPLL (2020)",  low = "white", high = "red",  
                        label = scales::comma) + 
  theme(legend.position = "right") +
  labs(title = "")

#Life Expectancy (low values bad --> color adjust across two plots)
# plot_usmap(data = county_df, values = "Life_Expectancy", color = "black") + 
#   scale_fill_continuous(low = "red", high = "white", name = "Life Expectancy (2020)", label = scales::comma) + 
#   theme(legend.position = "right") +
#   labs(title = "")
```

### Demographic

```{r}
#state level demo data
demo_response_df = reliable_data %>%
  group_by(State) %>%
  slice(1) %>%
  ungroup(State) %>%
  rename(., state = State, YPLL = 'Years of Potential Life Lost Rate', Life_Expectancy = 'Life Expectancy') %>%
  select(., contains(c("YPLL Rate (", "state")))

#Check unreliable demo ypll across states
# quick = function(x){x %>% is.na() %>% sum()}
# 
# demo_response_df %>%
#   select(., contains("Unreliable")) %>%
#   apply(., MARGIN = 2, FUN = quick)

#remove unreliable demo information
index = as.numeric(is.na(demo_response_df$`YPLL Rate (AIAN) Unreliable`))
demo_response_df$`YPLL Rate (AIAN)`[which(index == 0)] = NA

#long format data
demo_response_clean_df = demo_response_df %>%
  select(., -contains("Unreliable")) %>%
  pivot_longer(cols = !state,
               names_to = "Race", values_to = "YPLL")
```

```{r}
demo_map = function(df = demo_response_clean_df, Race_Type, limit_set = c()) {
  
  plot_usmap(data = filter(df, Race == Race_Type), values = "YPLL", color = "black") + 
  scale_fill_continuous(low = "white", high = "red", name = "YPLL (2020)", label = scales::comma, limits = limit_set) + 
  theme(legend.position = "right") +
  labs(title = Race_Type)
  
}

#Difficult to set standard limits because range varies significantly across demographic groups
demo_map(Race_Type = "YPLL Rate (AIAN)")
demo_map(Race_Type = "YPLL Rate (Asian)")
demo_map(Race_Type = "YPLL Rate (Black)")
demo_map(Race_Type = "YPLL Rate (Hispanic)")
demo_map(Race_Type = "YPLL Rate (white)")
```

## Predictors

```{r, include=F}
test_func = function(df = state_df, var_name){ 
  
  ggplot(df, aes(x = get(var_name))) + #use get to transform char to var name
    geom_histogram()
}

test_func(var_name = "Deaths")
```

```{r}
#State Level
pred_df = reliable_data %>%
  group_by(State) %>%
  slice(1) %>%
  rename(., state = State, YPLL = 'Years of Potential Life Lost Rate') %>%
  summarise(#alcohol/drug
            drink_per = `% Excessive Drinking`, dui_per = `% Driving Deaths with Alcohol Involvement`, 
            od_num = `# Drug Overdose Deaths`, vehicle_death = `# Motor Vehicle Deaths`, obesity_rate = `% Adults with Obesity`, 
            #food/exercise
            food_index = `Food Environment Index`, inactive_per = `% Physically Inactive`, 
            exercise_access_per = `% With Access to Exercise Opportunities`, food_per = `% Food Insecure`, 
            healthy_access_per = `% Limited Access to Healthy Foods`,
            #tobacco
            smoke = `% Smokers`, 
            #sex
            std = `Chlamydia Rate`, 
            #response
            YPLL)

#Linear Correlation Matrix (Response vs Predictors)
cor(pred_df[,-1], pred_df[,length(pred_df)]) %>% 
  round(., 3) %>% 
  as.data.frame() %>% 
  mutate(YPLL_abs = abs(YPLL)) %>%
  arrange(desc(YPLL_abs))
```

```{r}
#County Level
df = reliable_data %>%
  group_by(State, County) %>%
  rename(., state = State, YPLL = 'Years of Potential Life Lost Rate') %>%
  summarise(#alcohol/drug
            drink_per = `% Excessive Drinking`, dui_per = `% Driving Deaths with Alcohol Involvement`, 
            od_num = `# Drug Overdose Deaths`, vehicle_death = `# Motor Vehicle Deaths`, obesity_rate = `% Adults with Obesity`, 
            #food/exercise
            food_index = `Food Environment Index`, inactive_per = `% Physically Inactive`, 
            exercise_access_per = `% With Access to Exercise Opportunities`, food_per = `% Food Insecure`, 
            healthy_access_per = `% Limited Access to Healthy Foods`,
            #tobacco
            smoke = `% Smokers`, 
            #sex
            std = `Chlamydia Rate`, 
            #response
            YPLL) %>% 
  na.omit()

#Remove char col

num_df = df[ , !sapply(df, is.character)]

#Linear Correlation Matrix (Response vs Predictors)
cor(num_df, df[,length(df)]) %>% 
  round(., 3) %>% 
  as.data.frame() %>% 
  mutate(YPLL_abs = abs(YPLL)) %>%
  arrange(desc(YPLL_abs))
```


```{r, include = F}
#Dataframe with all the predictors
#Comparing county differences if we omit all NAs
no_na_pred_df = reliable_data %>%
  group_by(State, County) %>%
  rename(., state = State, YPLL = 'Years of Potential Life Lost Rate') %>%
  summarise(#alcohol/drug
            drink_per = `% Excessive Drinking`, dui_per = `% Driving Deaths with Alcohol Involvement`, 
            od_num = `# Drug Overdose Deaths`, vehicle_death = `# Motor Vehicle Deaths`, obesity_rate = `% Adults with Obesity`, 
            #food/exercise
            food_index = `Food Environment Index`, inactive_per = `% Physically Inactive`, 
            exercise_access_per = `% With Access to Exercise Opportunities`, food_per = `% Food Insecure`, 
            healthy_access_per = `% Limited Access to Healthy Foods`,
            #tobacco
            smoke = `% Smokers`, 
            #sex
            std = `Chlamydia Rate`, 
            #response
            YPLL) %>%
  na.omit()

county_df = reliable_data %>%
  group_by(State, County) %>%
  rename(., state = State, YPLL = 'Years of Potential Life Lost Rate') %>%
  summarise(#alcohol/drug
            drink_per = `% Excessive Drinking`, dui_per = `% Driving Deaths with Alcohol Involvement`, 
            od_num = `# Drug Overdose Deaths`, vehicle_death = `# Motor Vehicle Deaths`, obesity_rate = `% Adults with Obesity`, 
            #food/exercise
            food_index = `Food Environment Index`, inactive_per = `% Physically Inactive`, 
            exercise_access_per = `% With Access to Exercise Opportunities`, food_per = `% Food Insecure`, 
            healthy_access_per = `% Limited Access to Healthy Foods`,
            #tobacco
            smoke = `% Smokers`, 
            #sex
            std = `Chlamydia Rate`, 
            #response
            YPLL)

setdiff(county_df, no_na_pred_df) %>% #find rows not in subsetted df comparing to parent df
  is.na() %>% 
  colSums()
```

#### Tobacco 

```{r}
state_tobacco_sex_df = reliable_data %>%
  group_by(State) %>%
  slice(1) %>%
  rename(., state = State, YPLL = 'Years of Potential Life Lost Rate') %>%
  summarise(smoke = `% Smokers`, std = `Chlamydia Rate`, YPLL)

county_tobacco_sex_df = reliable_data %>%
  group_by(State, County) %>%
  rename(., state = State, YPLL = 'Years of Potential Life Lost Rate') %>%
  summarise(county_class, smoke = `% Smokers`, std = `Chlamydia Rate`, YPLL) %>%
  na.omit()

#map
plot_usmap(data = state_tobacco_sex_df, values = "smoke", color = "black") + 
  scale_fill_continuous(name = "% Smokers (2020)",  low = "white", high = "red",  
                        label = scales::comma) + 
  theme(legend.position = "right") +
  labs(title = "")

#plot against YPLL (State) cor = 0.82
ggplot(state_tobacco_sex_df, aes(x = YPLL, y = smoke)) +
  geom_point(alpha = 0.25) + #geom_smooth(se = F, method = "lm") +
  theme_bw() +
  labs(title = "YPLL Increases As Smoking Prevelance Increases", x = "Years of Potential Life Lost (YPLL)", y = "% Smokers")

#plot against YPLL (County) cor = 0.74
ggplot(county_tobacco_sex_df, aes(x = YPLL, y = smoke, color = county_class)) +
  geom_point(alpha = 0.25) + #geom_smooth(se = F, method = "lm") +
  theme_bw() +
  labs(title = "YPLL Increases As Smoking Prevelance Increases", x = "Years of Potential Life Lost (YPLL)", y = "% Smokers",
       color = "County Class")
```

#### Sex

```{r}
#map
plot_usmap(data = state_tobacco_sex_df, values = "std", color = "black") + 
  scale_fill_continuous(name = "# Chlamydia Cases (2020)",  low = "white", high = "red",  
                        label = scales::comma) + 
  theme(legend.position = "right") +
  labs(title = "")

#plot against smoke (State)
ggplot(state_tobacco_sex_df, aes(x = std, y = smoke)) +
  geom_point(alpha = 0.25) + geom_smooth(se = F, method = "lm") + #no relationship
  theme_bw() +
  labs(title = "No Relationship Between Smoking and STD Prevelance", x = "Chlamydia Rate", y = "% Smokers")

#plot against smoke (County)
ggplot(county_tobacco_sex_df, aes(x = std, y = smoke, color = county_class)) +
  geom_point(alpha = 0.25) + geom_smooth(se = F, method = "lm") + #no relationship
  theme_bw() +
  labs(title = "County Level By Class Suggests Relationship", x = "Chlamydia Rate", y = "% Smokers", color = "County Class")

#plot against YPLL (State) cor = 0.37
ggplot(state_tobacco_sex_df, aes(y = YPLL, x = std)) +
  geom_point(alpha = 0.25) + geom_smooth(se = F, method = "lm") + #weak positive relationship
  theme_bw() +
  labs(title = "YPLL Increases Slightly As Chlamydia Rate Increases", x = "Years of Potential Life Lost (YPLL)", y = "Chlamydia Rate")

#plot against YPLL (County) cor = 0.24
ggplot(county_tobacco_sex_df, aes(y = YPLL, x = std, color = county_class)) +
  geom_point(alpha = 0.25) + geom_smooth(se = F, method = "lm") +
  theme_bw() +
  labs(title = "YPLL Increases Slightly As Chlamydia Rate Increases", x = "Years of Potential Life Lost (YPLL)", y = "Chlamydia Rate", 
       color = "County Class")
```

# Modeling

Consider Mixed Effects Model

#####HELP
What is difference between mixed model and the regressions with interactions (random effect is grouping, fixed effect is x)

Can consider using PCR where PC's represent correlated predictors (e.g., drug/alcohol or diet/exercise predictors may be PC1 and PC2)

```{r}
#model assumptions (State)
library(ggfortify)

simple_model = lm(YPLL ~ smoke + std, data = state_tobacco_sex_df)

autoplot(simple_model, ncol = 2) + theme_bw() #one or two outliers but otherwise pretty good

#Output
summary(simple_model) #this is actually pretty good and then x's seem to be independent of each other

#Due to potential violations of normality, (1) can try removing outliers, (2) use nonparametric regression
#Aggregated data: Underestimates variability, Inflated SE, Inflated R^2
```

```{r}
#County
county_simple_model = lm(YPLL ~ smoke + std, data = county_tobacco_sex_df)

autoplot(county_simple_model, ncol = 2) + theme_bw() #one or two outliers but otherwise pretty good

#Output
summary(county_simple_model) #this is actually pretty good and then x's seem to be independent of each other
```


# Conclusions










